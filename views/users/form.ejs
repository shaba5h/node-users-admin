<% layout('layouts/main') %>
<%
const isEdit = mode === 'edit';
%>

<!-- User Form Content -->
<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <div class="form-icon">
                <i class="fas fa-<%= mode === 'edit' ? 'edit' : 'plus' %>"></i>
            </div>
            <div class="form-title-section">
                <h2 class="form-title">
                    <%= mode === 'edit' ? 'Edit User' : 'Create New User' %>
                </h2>
                <p class="form-subtitle">
                    <%= mode === 'edit' ? 'Update user details in the form below' : 'Fill all required fields to create a user' %>
                </p>
            </div>
        </div>
        
        <form id="userForm" action="<%= mode === 'edit' && user ? `/admin/users/${user.id}` : '/admin/users' %>" 
              method="POST" 
              class="user-form" 
              novalidate>
            
            <!-- CSRF Token -->
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
            
            <!-- Method Override for Edit -->
            <% if (mode === 'edit') { %>
                <input type="hidden" name="_method" value="PUT">
            <% } %>
            
            <div class="form-body">
                <!-- Personal Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-user"></i>
                            Personal Information
                        </h3>
                        <p class="section-description">User basic details</p>
                    </div>
                    
                    <div class="form-row">
                        <!-- Username -->
                        <div class="form-group">
                            <label for="username" class="form-label required">
                                <i class="fas fa-at"></i>
                                Username
                            </label>
                            <input 
                                type="text" 
                                id="username" 
                                name="username" 
                                class="form-control <%= errors && errors.username ? 'is-invalid' : '' %>"
                                value="<%= user && user.username ? user.username : '' %>"
                                placeholder="Enter username"
                                required
                                minlength="3"
                                maxlength="100"
                                autocomplete="username"
                            >
                            <% if (errors && errors.username) { %>
                                <div class="invalid-feedback">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <%= errors.username %>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Password (only for new users) -->
                        <% if (mode !== 'edit') { %>
                            <div class="form-group">
                                <label for="password" class="form-label required">
                                    <i class="fas fa-lock"></i>
                                    Password
                                </label>
                                <div class="password-input-group">
                                    <input 
                                        type="password" 
                                        id="password" 
                                        name="password" 
                                        class="form-control <%= errors && errors.password ? 'is-invalid' : '' %>"
                                        placeholder="Enter password"
                                        required
                                        autocomplete="new-password"
                                        minlength="6"
                                        maxlength="100"
                                    >
                                    <button type="button" class="password-toggle" data-target="password">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <% if (errors && errors.password) { %>
                                    <div class="invalid-feedback">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <%= errors.password %>
                                    </div>
                                <% } %>
                            </div>
                        <% } %>
                    </div>
                    
                    <div class="form-row">
                        <!-- First Name -->
                        <div class="form-group">
                            <label for="firstName" class="form-label required">
                                <i class="fas fa-user"></i>
                                First name
                            </label>
                            <input 
                                type="text" 
                                id="firstName" 
                                name="first_name" 
                                class="form-control <%= errors && errors.first_name ? 'is-invalid' : '' %>"
                                value="<%= user && user.first_name ? user.first_name : '' %>"
                                placeholder="Enter first name"
                                required
                                maxlength="100"
                                autocomplete="given-name"
                            >
                            <% if (errors && errors.first_name) { %>
                                <div class="invalid-feedback">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <%= errors.first_name %>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Last Name -->
                        <div class="form-group">
                            <label for="lastName" class="form-label required">
                                <i class="fas fa-user"></i>
                                Last name
                            </label>
                            <input 
                                type="text" 
                                id="lastName" 
                                name="last_name" 
                                class="form-control <%= errors && errors.last_name ? 'is-invalid' : '' %>"
                                value="<%= user && user.last_name ? user.last_name : '' %>"
                                placeholder="Enter last name"
                                required
                                maxlength="100"
                                autocomplete="family-name"
                            >
                            <% if (errors && errors.last_name) { %>
                                <div class="invalid-feedback">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <%= errors.last_name %>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Additional Information
                        </h3>
                        <p class="section-description">User personal details</p>
                    </div>
                    
                    <div class="form-row">
                        <!-- Gender -->
                        <div class="form-group">
                            <label for="gender" class="form-label required">
                                <i class="fas fa-venus-mars"></i>
                                Gender
                            </label>
                            <select 
                                id="gender" 
                                name="gender" 
                                class="form-control <%= errors && errors.gender ? 'is-invalid' : '' %>"
                                required
                            >
                                <option value="">Select gender</option>
                                <option value="male" <%= user && user.gender === 'male' ? 'selected' : '' %>>
                                    Male
                                </option>
                                <option value="female" <%= user && user.gender === 'female' ? 'selected' : '' %>>
                                    Female
                                </option>
                            </select>
                            <% if (errors && errors.gender) { %>
                                <div class="invalid-feedback">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <%= errors.gender %>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Birthdate -->
                        <div class="form-group">
                            <label for="birthDate" class="form-label required">
                                <i class="fas fa-calendar"></i>
                                Birthdate
                            </label>
                            <input 
                                type="date" 
                                id="birthDate" 
                                name="birthdate" 
                                class="form-control <%= errors && errors.birthdate ? 'is-invalid' : '' %>"
                                value="<%= user && user.birthdate ? new Date(user.birthdate).toISOString().split('T')[0] : '' %>"
                                required
                                max="<%= new Date().toISOString().split('T')[0] %>"
                            >
                            <% if (errors && errors.birthdate) { %>
                                <div class="invalid-feedback">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <%= errors.birthdate %>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                
                <!-- Password Change Section (only for edit mode) -->
                <% if (mode === 'edit') { %>
                    <div class="form-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-key"></i>
                                Change Password
                            </h3>
                            <p class="section-description">Leave fields empty if you do not want to change the password</p>
                        </div>
                        
                        <div class="form-row">
                            <!-- New Password -->
                            <div class="form-group">
                                <label for="password" class="form-label">
                                    <i class="fas fa-lock"></i>
                                    New password
                                </label>
                                <div class="password-input-group">
                                    <input 
                                        type="password" 
                                        id="password" 
                                        name="password" 
                                        class="form-control <%= errors && errors.password ? 'is-invalid' : '' %>"
                                        placeholder="Enter new password"
                                        autocomplete="new-password"
                                        minlength="6"
                                        maxlength="100"
                                    >
                                    <button type="button" class="password-toggle" data-target="password">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <% if (errors && errors.password) { %>
                                    <div class="invalid-feedback">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <%= errors.password %>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
            
            <!-- Form Actions -->
            <div class="form-footer">
                <div class="form-actions">
                    <a href="/admin/users" class="btn btn-outline">
                        <i class="fas fa-times"></i>
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-<%= mode === 'edit' ? 'save' : 'plus' %>"></i>
                        <%= mode === 'edit' ? 'Save changes' : 'Create user' %>
                    </button>
                </div>
            </div>
        </form>
</div>
</div>
